name: stable-release

on:
  push:
    branches:
      - "**"

permissions:
  contents: write

jobs:
  build-release:
    if: contains(github.event.head_commit.message, 'stable release')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        run: |
          git init .
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin "${{ github.sha }}"
          git checkout -f "${{ github.sha }}"

      - name: Setup Go
        run: |
          curl -fsSL "https://go.dev/dl/go1.22.0.linux-amd64.tar.gz" -o /tmp/go.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          echo "/usr/local/go/bin" >> "$GITHUB_PATH"

      - name: Build
        run: |
          mkdir -p dist
          export CGO_ENABLED=0
          targets="linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64 windows/arm64 freebsd/amd64 freebsd/arm64 openbsd/amd64 openbsd/arm64"
          for target in $targets; do
            GOOS="${target%/*}"
            GOARCH="${target#*/}"
            output="chicha-ip-proxy_${GOOS}_${GOARCH}"
            if [ "$GOOS" = "windows" ]; then
              output="${output}.exe"
            fi
            GOOS="$GOOS" GOARCH="$GOARCH" /usr/local/go/bin/go build -trimpath -ldflags="-s -w" -o "dist/${output}" .
            tar -czf "dist/${output}.tar.gz" -C dist "${output}"
          done

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="stable-${{ github.sha }}"
          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" --title "$tag" --notes "Automated stable release for ${{ github.sha }}."
          fi
          gh release upload "$tag" dist/*.tar.gz --clobber
