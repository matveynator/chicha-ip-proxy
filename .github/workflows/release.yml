name: stable-release

on:
  push:
    branches:
      - "**"

jobs:
  build-release:
    if: contains(github.event.head_commit.message, 'stable release')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
          - goos: freebsd
            goarch: amd64
          - goos: freebsd
            goarch: arm64
          - goos: openbsd
            goarch: amd64
          - goos: openbsd
            goarch: arm64
    steps:
      - name: Checkout
        run: |
          git init .
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git fetch --depth=1 origin "${{ github.sha }}"
          git checkout -f "${{ github.sha }}"

      - name: Setup Go
        run: |
          curl -fsSL "https://go.dev/dl/go1.22.0.linux-amd64.tar.gz" -o /tmp/go.tar.gz
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tar.gz
          echo "/usr/local/go/bin" >> "$GITHUB_PATH"

      - name: Build
        run: |
          mkdir -p dist
          export CGO_ENABLED=0
          export GOOS=${{ matrix.goos }}
          export GOARCH=${{ matrix.goarch }}
          output="chicha-ip-proxy_${GOOS}_${GOARCH}"
          if [ "$GOOS" = "windows" ]; then
            output="${output}.exe"
          fi
          /usr/local/go/bin/go build -trimpath -ldflags="-s -w" -o "dist/${output}" .
          tar -czf "dist/${output}.tar.gz" -C dist "${output}"

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="stable-${{ github.sha }}"
          if ! gh release view "$tag" >/dev/null 2>&1; then
            gh release create "$tag" --title "$tag" --notes "Automated stable release for ${{ github.sha }}." || true
          fi
          for i in 1 2 3 4 5; do
            if gh release view "$tag" >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done
          gh release upload "$tag" dist/*.tar.gz --clobber
